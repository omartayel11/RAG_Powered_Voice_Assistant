from langchain.chains import LLMChain
from langchain_core.prompts import ChatPromptTemplate, HumanMessagePromptTemplate, MessagesPlaceholder
from langchain_core.messages import SystemMessage
from langchain.chains.conversation.memory import ConversationBufferWindowMemory
from langchain_groq import ChatGroq
import chromadb
from chromadb.utils import embedding_functions
from groq import Groq
from datetime import datetime


def retrieve_data(query):
    """
    Retrieves top matching recipes from ChromaDB and returns both titles and documents.
    """
    chroma_client = chromadb.HttpClient(host='localhost', port=8000)

    model_name = "akhooli/Arabic-SBERT-100K"
    sentence_transformer_ef = embedding_functions.SentenceTransformerEmbeddingFunction(model_name=model_name)

    try:
        collection = chroma_client.get_collection("recipestest", embedding_function=sentence_transformer_ef)
        print("Collection 'recipestest' found.")
    except chromadb.errors.InvalidCollectionException:
        print("Collection 'recipestest' does not exist. Please add data first.")
        return []

    results = collection.query(
        query_texts=[query],
        n_results=7,
        include=["documents", "metadatas"]  # Correct: include metadatas, not ids.
    )

    print("๐ Raw ChromaDB Results:", results)

    structured_results = []
    for doc, metadata in zip(results["documents"][0], results["metadatas"][0]):
        structured_results.append({
            "title": metadata.get("title", "ูุตูุฉ ุจุฏูู ุนููุงู"),
            "document": doc
        })


    return structured_results



def enhance_query_with_groq(query, chat_context=""):
    """
    This function uses the Groq API to enhance the query and determine if it's food-related.
    """
    api_key = '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'

    client = Groq(api_key=api_key)
    system_prompt = """
ุฃูุช ูุฑุงูุจ ูุชุญููู ุงููุญุงุฏุซุฉ ุจูู ุงููุณุชุฎุฏู ูุงูุฑูุจูุชุ ููุฏูู ูู ุชุตููู ูู ูููู ุจุฏูุฉ ูุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ูุฌุจ ุชูููุฐ ุงุณุชุฑุฌุงุน ููุตูุฉ ุทุนุงู.

 ูุฌุจ ุชุตููู ุงูุญุงูุฉ ุฅูู ูุงุญุฏุฉ ููุท ูู ุงููุฆุงุช ุงูุฃุฑุจุน ุงูุชุงููุฉ:

1. not food related  
2. respond based on chat history  
3. food generalized  
4. [ุงุณู ุงูุฃููุฉ ุฃู ููุน ุงูุทุนุงู]

---

 1. not food related  
ุงุณุชุฎุฏู ูุฐุง ุงูุชุตููู ุนูุฏูุง ูููู ุงูุญุฏูุซ:
- ุงุฌุชูุงุนู ุฃู ุชุนุงุฑู ููุท
- ุฃู ุชุนุจูุฑ ุนู ุงูุฌูุน ุฃู ุงูุฑุบุจุฉ ุงูุนุงูุฉ ุจุงูุฃูู ุจุฏูู ููุฉ ุงูุทูุจ
- ุฃู ูุญุชูู ุนูู ุฐูุฑ ุทุนุงู ููุท ููุนูููุฉ ุดุฎุตูุฉ ุฃู ุฑุฃู ุจุฏูู ููุฉ ุงุณุชุฑุฌุงุน
- ุฃู ุนูุฏูุง ูุง ููุฌุฏ ุฃู ุฅุดุงุฑุฉ ูุงุถุญุฉ ุฅูู ููุฉ ุงูุญุตูู ุนูู ูุตูุฉ

 ููู: ุญุชู ูู ุฐููุฑ ุงููุณุชุฎุฏู ุงุณู ุฃููุฉุ ูุง ุชุฎุฑุฌูุง ุฅู ูู ููู ููุงู ุทูุจ ุตุฑูุญ ุฃู ููุงููุฉ ูุงุถุญุฉ.

**ุฃูุซูุฉ:**
- "ุฃูุง ุฌุนุงู"
- "ููุช ุจููุฑ ูู ุงูุฃูู"
- "ุจุญุจ ุดูุฑุจุฉ ุนุฏุณ"
- "ุงูุฃูู ุงููุตุฑู ูููุฒ"
- "ุงูุฃููุฉ ุฏู ุฐูุฑุชูู ุจุฃูุงู ุฒูุงู"
- "ุฃูุง ุจุญุจ ุงูุฃูู ุงููุจุงุชู"
- "ุฒูุงู ููุช ุจุงูู ูุดุฑู ูู ุฃุณุจูุน"
- "ุฃูุง ุดุจุนุงู ุจุณ ุจุญุจ ุงููููุฎูุฉ"
- "ุชุญุจ ูุญูู ุนู ุฃููุงุช ูู ุฒูุงูุ"
- "ุงูุฃูู ุนููููุง ูุฐูุฐ"

---

 2. respond based on chat history  
ุงุณุชุฎุฏู ูุฐุง ุงูุชุตููู ุฅุฐุง ูุงู ุญุฏูุซ ุงููุณุชุฎุฏู ุชุนููููุง ุฃู ูุชุงุจุนุฉ ููุตูุฉ ุชู ุนุฑุถูุง ูุณุจููุง ูู ููุณ ุงูุฌูุณุฉุ ูุซู ุชุฌุฑุจุฉุ ุชุฃููุฏุ ุฃู ููุงููุฉ ูุชุฃุฎุฑุฉ.

**ุฃูุซูุฉ:**
- "ุฌุฑุจุชูุง ููุงูุช ููุชุงุฒุฉ"
- "ุขู ูุนูุงู ุทูุนุช ุญููุฉ"
- "ุงููู ูุงุชุช ูุงูุช ูุฐูุฐุฉ"
- "ูุฑุฌุน ูููุตูุฉ ุงููู ูุงุชุช"
- "ูุงุดู ูุนูู ุงููู ูุงุชุช ุชุงูู"
- "ุนุฌุจุชูู ุงููุตูุฉ ุงููู ูุงุชุช"
- "ูุง ุงูุง ุนุงูุฒ ุงููุตูู ุฏู ู ูููู ูุดูู ูููุง ุงูุจุตู"

---

 3. food generalized  
ุงุณุชุฎุฏู ูุฐุง ุงูุชุตููู ุนูุฏูุง ูุชุญุฏุซ ุงููุณุชุฎุฏู ุนู ููุน ุทุนุงู ุนุงู ุจุฏูู ุชุญุฏูุฏ ุงุณู ุฃููุฉุ ูุน ูุถูุญ ููุชู ูู ุงูุฃูู ุฃู ุงูุญุตูู ุนูู ุงูุชุฑุงุญุ ูููู ุฏูู ุฐูุฑ ุฃููุฉ ูุญุฏุฏุฉ ุจุนุฏ.

**ุฃูุซูุฉ:**
- "ุฃูุง ุนุงูุฒ ุดูุฑุจุฉ"
- "ููุณู ูู ุญุงุฌุฉ ูุจุงุชูุฉ"
- "ุฃูุง ุจููุฑ ูู ุฃูู ุจุญุฑู"
- "ุญุงุจุจ ุญุงุฌุฉ ุฎูููุฉ"
- "ุฃูุง ุญุงุจุจ ุฃููุฉ ูู ุงููุฑู"
- "ูููู ูุนูู ุญุงุฌุฉ ูุดููุฉุ"
- "ุฃูุง ูุงูู ูููุนุฌูุงุช"
- "ุฃูุง ุนุงูุฒ ุญุงุฌุฉ ุณุฎูุฉ"
- "ูููู ุฃูู ุนูู ุงูุณุฑูุนุ"
- "ุญุงุจุจ ุฃุจุฏุฃ ุจุญุงุฌุฉ ุฎูููุฉ"
- "ุฃูุง ุจููุฑ ูู ุตูู ุฎููู ูุด ุชููู"

 ููุงุญุธุฉ: ูู ูุฐู ุงูุญุงูุงุชุ ูุง ูุชู ุชูููุฐ ุงูุงุณุชุฑุฌุงุน ุจุนุฏ โ ุจู ููุชุฑู ุงููุฑุงุฑ ููุฑูุจูุช ููููุฏ ุงูุญูุงุฑ ูุญู ุชุญุฏูุฏ ุฃููุฉ ูุงุถุญุฉ.

---

 4. [ุงุณู ุงูุฃููุฉ ุฃู ููุน ุงูุทุนุงู]
ุงุณุชุฎุฏู ูุฐุง ุงูุชุตููู ููุท ุนูุฏูุง:
- ูุทูุจ ุงููุณุชุฎุฏู ุตุฑุงุญุฉ ุฃููุฉ ุฃู ูุตูุฉ ูุญุฏุฏุฉ
- ุฃู ููุงูู ุจูุถูุญ ุนูู ุงูุชุฑุงุญ ูุนูู ุชู ุชูุฏููู ูู ุงูุฑุณุงูุฉ ุงูุณุงุจูุฉ ูู ุงูุฑูุจูุช (ููู ูุชู ุนุฑุถู ุจุนุฏ)

 ูู ูุฐู ุงูุญุงูุฉุ ูุฌุจ ุฃู ุชุณุชุฎุฑุฌ ุงุณู ุงูุฃููุฉ ูู ุฑุณุงูุฉ ุงููุณุชุฎุฏู ุฃู ูู ุงูุงูุชุฑุงุญ ุงูุณุงุจู ูู ุงูุฑูุจูุช.

 ูุง ุชุณุชุฎุฏู ูุฐุง ุงูุชุตููู ุฅุฐุง ูู ุชูู ููุงู ููุฉ ูุงุถุญุฉ ูุทูุจ ุงููุตูุฉ ุฃู ููุงููุฉ ูุจุงุดุฑุฉ ุนูู ุงูุชุฑุงุญ.

**ุฃูุซูุฉ:**
- "ูุงุชูู ูุตูุฉ ุดูุฑุจุฉ ุนุฏุณ" โถ ุดูุฑุจุฉ ุนุฏุณ  
- "ุฃูุง ุนุงูุฒ ูุดุฑู" โถ ูุดุฑู  
- "ุฌุฑุจูู ุงููุณูุนุฉ" โถ ูุณูุนุฉ  
- "ูููู ูุตูุฉ ุทุงุฌู ุจุงููุฉุ" โถ ุทุงุฌู ุจุงููุฉ  
- "ููุณู ูู ุฃููุฉ ูููุง ุฌูุจุฑู" โถ ุฃููุฉ ูููุง ุฌูุจุฑู  
- ุงูุฑูุจูุช: "ุชุญุจ ุดูุฑุจุฉ ุงูุทูุงุทูุ"  
  ุงููุณุชุฎุฏู: "ุขู ุฌุฑุจูุง" โถ ุดูุฑุจุฉ ุงูุทูุงุทู  
- ุงูุฑูุจูุช: "ูููู ูุนูู ูุจุณุฉุ"  
  ุงููุณุชุฎุฏู: "ูุงุดู" โถ ูุจุณุฉ  
- ุงูุฑูุจูุช: "ุชุญุจ ุฃุนููู ุดูุด ุทุงูููุ"  
  ุงููุณุชุฎุฏู: "ุฃููู ุฌุฑุจ" โถ ุดูุด ุทุงููู  

---

 ุชุนูููุงุช ุฅุถุงููุฉ ููุชุนุงูู ูุน ุงูุญุงูุงุช ุงูุฎุงุตุฉ:

- ุฅุฐุง ุงุญุชูุช ุงูุฑุณุงูุฉ ุนูู ููุน ุทุนุงู ุนุงู ูุฃููุฉ ูุญุฏุฏุฉุ ูุชู ุงุฎุชูุงุฑ [ุงุณู ุงูุฃููุฉ] ููุท ุฅู ููุฌุฏุช ููุฉ ูุงุถุญุฉ ููุทูุจ ุฃู ุงูููุงููุฉ.
- ุงูุนุจุงุฑุงุช ูุซู "ููู ูุฃ"ุ "ูุงุดู ุฌุฑุจูุง"ุ "ุชูุงู ุงูุดู ุนูููุง" ุชูุนุชุจุฑ ููุงููุฉ ุตุฑูุญุฉ ุฅุฐุง ุฌุงุกุช ูุจุงุดุฑุฉ ุจุนุฏ ุงูุชุฑุงุญ ูู ุงูุฑูุจูุช.
- ุฅุฐุง ุฑูุถ ุงููุณุชุฎุฏู ุงูุงูุชุฑุงุญ (ูุซู: "ูุด ุนุงูุฒ ูุจุณุฉ") ูุง ูุชู ุชูููุฐ ุงูุงุณุชุฑุฌุงุน ููุฐุง ุงูุงูุชุฑุงุญ.
- ุฅุฐุง ูุงูู ุงููุณุชุฎุฏู ุนูู ุงูุชุฑุงุญ ุบูุฑ ูุญุฏุฏ (ูุซู: "ูููู ูุนูู ุฃููุฉุ" โ "ูุงุดู") ููุฐุง ูุง ููุนุชุจุฑ ููุงููุฉ ุนูู ููุน ุทุนุงู ูุนูู.

---

 ููููุน ููุนูุง ุจุงุชูุง:
- ูุง ุชุฎุฑุฌ ุงุณู ุฃููุฉ ุฅูุง ุฅุฐุง ููุฌุฏ ุทูุจ ุตุฑูุญ ุฃู ููุงููุฉ ุตุฑูุญุฉ ุนูู ุงูุชุฑุงุญ ูุญุฏุฏ.
- ูุง ุชุฎุชุฑุน ุฃููุฉ ุฃู ุชูุชุฑุถ ููุฉ ุบูุฑ ูุฐููุฑุฉ.
- ูุง ุชููููุ ูุง ุชุดุฑุญุ ูุง ุชูุณูุฑ.
- ูุง ุชุชูุงุนู โ ููุท ุตููู ุจุฏูุฉ.

---

 ุงููุฎุฑุฌุงุช ุงูููุจููุฉ ููุท:

- not food related  
- respond based on chat history  
- food generalized  
- [ุงุณู ุฃููุฉ ุฃู ููุน ุทุนุงู ุญูููู ูุฐููุฑ ุจูุถูุญ ููุท]
ุจุฏูู ุงู ุฒุฎุงุฑูุ ุนูุงูุงุช ุชุฑูููุ ุฃู ุชูุณูู ุฎุงุต ุงู ุดุฑุญ ุงู ุงุณุจุงุจ ุงู ุชุนูููุงุช 

"""

#     system_prompt = """ุฃูุช ูุฑุงูุจ ูุชุญููู ุงููุญุงุฏุซุฉ ุจูู ุงููุณุชุฎุฏู ูุงูุฑูุจูุชุ ูุฏูู ุชุญุฏูุฏ ูุชู ูุฌุจ ุชูููุฐ ุงุณุชุฑุฌุงุน ููุตูุฉ ุทุนุงู.

# ููุงุนุฏ ุงูุชุตููู:

# ูก. ุฅุฐุง ูุงู ุงูุญุฏูุซ ุงุฌุชูุงุนููุงุ ุฃู ูุฌุฑุฏ ุฐูุฑ ููุทุนุงู ุจุดูู ุนุงูุ ุฃู ุงููุณุชุฎุฏู ูุทูุจ ุงูุชุฑุงุญุงุช ุจุฏูู ุฐูุฑ ุงุณู ุฃููุฉ ุฃู ููุน ุทุนุงู ูุญุฏุฏุ ูุงููุชูุฌุฉ:
# not food related

# ูข. ุฅุฐุง ูุงู ุงูุญุฏูุซ ูุชุงุจุนุฉ ุฃู ุชุนููู ุนูู ูุตูุฉ ุชู ุนุฑุถูุง ุณุงุจููุงุ ูุงููุชูุฌุฉ:
# respond based on chat history

# ูฃ. ุฅุฐุง ุฐูุฑ ุงููุณุชุฎุฏู ุตุฑุงุญุฉ ุงุณู ุฃููุฉ ุฃู ููุน ุทุนุงู (ูุซู: ูุดุฑูุ ุดูุฑุจุฉ ูุฑุงุฎุ ุฃููุฉ ูููุง ุฌูุจุฑู)ุ ุฃู ูุงูู ุจูุถูุญ ุนูู ุงูุชุฑุงุญ ูุญุฏุฏ ููุฏู ูู ููู ูุชู ุนุฑุถ ูุตูุชู ุจุนุฏุ ูุงููุชูุฌุฉ:
# ุงุณู ุงูุฃููุฉ ุฃู ููุน ุงูุทุนุงู ุจุงููุบุฉ ุงูุนุฑุจูุฉ ููุท

# ููููุน ููุนูุง ุจุงุชูุง:

# - ูุง ุชุฎุชุฑุน ุฃููุฉ ุฃู ูุตูุฉ ูู ุฎูุงูู.
# - ูุง ุชุจุชูุฑ ุงูุชุฑุงุญุงุช ุจูุงุกู ุนูู ูุฌุฑุฏ ุทูุจ ุนุงู ูุซู "ุงูุชุฑุญ ุนููุง" ุฃู "ููู ุญุงุฌุฉ".
# - ูุง ุชุชุตุฑู ููุฃูู ุฌุฒุก ูู ุงููุญุงุฏุซุฉ.
# - ูุง ุชูุณุฑ ุฃู ุชุดุฑุญ.
# - ูุง ุชุถูู ุฃูุซูุฉ ุฃู ุฒุฎุงุฑู.
# - ููุท ุญูู ูุงุฎุฑุฌ ุงููุชูุฌุฉ ุงูุตุญูุญุฉ ุจุฏูู ุฃู ุฅุถุงูุฉ.

# ููู ุฌุฏูุง:
# - ูุง ุชุณุชุฎุฑุฌ ุงุณู ุฃููุฉ ุฅูุง ุฅุฐุง ุฐููุฑุช ุจูุถูุญ ูู ุงููุณุชุฎุฏู ุฃู ุงูุฑูุจูุช.
# - ุฅุฐุง ูู ูุฐูุฑ ุงููุณุชุฎุฏู ุฃู ุงูุฑูุจูุช ุฃููุฉ ุฃู ููุน ุทุนุงู ูุญุฏุฏุ ููุง ุชุฎุฑุฌ ุงุณู ุฃููุฉ ุฃุจุฏุงูุ ุญุชู ูู ุทูุจ ุงูุชุฑุงุญูุง.

# ---

# ูุงู ุฌุฏูุง:
# - ูุง ุชุนุชุจุฑ ูุฌุฑุฏ ุฐูุฑ ุงูุทุนุงู (ูุซู: ุนุงูุฒ ูุชููู ุนู ุงูุฃูู) ูุทูุจ ุงุณุชุฑุฌุงุน.
# - ุงูุชุธุฑ ุทูุจ ูุงุถุญ ุฃู ููุงููุฉ ุตุฑูุญุฉ ูุฑุชุจุทุฉ ุจุงูุชุฑุงุญ ุญูููู ูุฏูู ุงูุฑูุจูุช ููู ูุชู ุนุฑุถู ุจุนุฏ.
# - ุฅุฐุง ุชู ุนุฑุถ ูุตูุฉ ุจุงููุนูุ ูุงูููุงููุฉ ุจุนุฏูุง ุชุนุชุจุฑ ุชุนููููุงุ ูููุณุช ุทูุจูุง ุฌุฏูุฏูุง.

# ---

# ุฏูุฑู ูู ุฃู ุชููู ุฏููููุง ุฌุฏูุง ููุง ุชุชุฏุฎู ุฃุจุฏูุง ูู ุชุฏูู ุงููุญุงุฏุซุฉ.
#  """
# """ ุฃูุช ูุณุงุนุฏ ุชุนุฒูุฒ ุงุณุชุนูุงูุงุช ูุฑูุจูุช ุฏุฑุฏุดุฉ ูุชุฎุตุต ูู ุงูุทุนุงู. ุฏูุฑู ูู ุชุญููู ุงููุญุงุฏุซุฉ ุจูู ุงููุณุชุฎุฏู ูุงูุฑูุจูุช (ุขุฎุฑ 7 ุฑุณุงุฆู ุนูู ุงูุฃูู) ูุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ูุฌุจ ุชูููุฐ ุงุณุชุฑุฌุงุน ููุตูุฉ ูุนููุฉ.

# ูุง ุชุนุชูุฏ ููุท ุนูู ุฑุณุงูุฉ ุงููุณุชุฎุฏู ุงูุฃุฎูุฑุฉ. ูุฌุจ ุฃู ุชูุฑุฃ ุงููุญุงุฏุซุฉ ุงูุณุงุจูุฉ ุจุนูุงูุฉ ูุชููู ุงูุณูุงู ุงููุงูู.

# ุงูุฑุฏ ุงูุฐู ุชุฎุฑุฌู ูุฌุจ ุฃู ูููู ูุงุญุฏูุง ููุท ูู:

# 1. not food related
# 2. respond based on chat history
# 3. ุฃู ุงุณู ุฃููุฉ ุฃู ููุน ุทุนุงู ููุชูุจ ุจุงูุนุฑุจูุฉ ููุท (ูุซุงู: ุดูุฑุจุฉ ูุฑุงุฎุ ูุดุฑูุ ุฃููุฉ ูููุง ูุญูุฉ)

# ---

# ุงูุญุงูุงุช ุงูุชู ูุฌุจ ูููุง ุฅุฎุฑุงุฌ "not food related":

# - ุฅุฐุง ูุงู ุงูุญุฏูุซ ูุง ุนูุงูุฉ ูู ุจุงูุฃูู.
# - ุฅุฐุง ูุงูุช ุงูุฑุณุงุฆู ูููุง ุงุฌุชูุงุนูุฉุ ุดุฎุตูุฉุ ุฃู ูุง ุชุชุนูู ุจุงููุตูุงุช ุฃู ุงูุทุนุงู.

# ---

# ุงูุญุงูุงุช ุงูุชู ูุฌุจ ูููุง ุฅุฎุฑุงุฌ "respond based on chat history":

# - ุฅุฐุง ูุงูุช ุฑุณุงูุฉ ุงููุณุชุฎุฏู ูุชุงุจุนุฉ ูุจุงุดุฑุฉ ููุตูุฉ ุชู ุงุณุชุฑุฌุงุนูุง ุจุงููุนู (ูุซู: "ูููุน ุฃุนูููุง ูู ุบูุฑ ุจุตูุ" ุฃู "ูู ูููุง ุณุจุงูุณูุ").
# - ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุนููู ุนูู ูุตูุฉ ุชู ุนุฑุถูุง ุจุงููุงูู ุณุงุจููุง.
# - ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุฃู ุนู ุชุนุฏูู ูู ูุตูุฉ ุชู ุชูุฏูููุง ูุนูุงู.

# ---

# ุงูุญุงูุงุช ุงูุชู ูุฌุจ ูููุง ุฅุฎุฑุงุฌ ุงุณุชุนูุงู (ุงุณู ุฃููุฉ ุฃู ููุน ุทุนุงู):

# - ุฅุฐุง ุนุจูุฑ ุงููุณุชุฎุฏู ุจูุถูุญ ุนู ุฑุบุจุชู ูู ููุน ุทุนุงู ุฃู ุฃููุฉ ูุญุฏุฏุฉ.
# - ุฅุฐุง ูุงูู ุงููุณุชุฎุฏู ุนูู ุงูุชุฑุงุญ ูุฏููู ุงูุฑูุจูุช ูู ุฑุณุงูุฉ ุณุงุจูุฉ (ุญุชู ูู ูู ูุฐูุฑ ุงุณู ุงูุฃููุฉ ุจููุณู).

# **ูุซุงู ููู ุฌุฏูุง:**
# - ุงูุฑูุจูุช: "ุชุญุจ ุดูุฑุจุฉ ูุฑุงุฎุ"
# - ุงููุณุชุฎุฏู: "ูุงุดูุ ูุงุช ุงููุตูุฉ" โ ูู ูุฐู ุงูุญุงูุฉ ูุฌุจ ุฃู ุชุฎุฑุฌ: ุดูุฑุจุฉ ูุฑุงุฎ

# **ุณุจุจ ุฐูู:** ุงููุณุชุฎุฏู ูุงูู ุถููููุง ุนูู ุงูุงูุชุฑุงุญ ููุทูุจ ูุตูุชู. ูุฐุง ูุฌุจ ุฃู ูุณุชุฎุฑุฌ ุงููุธุงู ููุฉ ุงูุงุณุชุฑุฌุงุน ูู ุงูุงูุชุฑุงุญ ุงูุณุงุจู.

# ---

# ููุงุญุธุงุช ุฃุณุงุณูุฉ:

# - ูุง ุชุฎุฑุฌ "respond based on chat history" ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ููุงูู ุนูู ูุตูุฉ ุชู ุงูุชุฑุงุญูุง ูู ุงูุฑูุจูุช ููู ูุชู ุงุณุชุฑุฌุงุนูุง ุจุนุฏ.
# - ุงููุทููุจ ูู ุงุชุฎุงุฐ ุงููุฑุงุฑ ุงูุฐูู ุจูุงุกู ุนูู ููู ูุดุชุฑู ุจูู ูุง ูุงูู ุงูุฑูุจูุช ููุง ูุงูู ุนููู ุงููุณุชุฎุฏู.
# - ุงุฐุง ูู ููู ููุงู ููุงููุฉ ูุงุถุญุฉ ูู ุงููุณุชุฎุฏู ุนูู ููุชุฑุญ ุงูุฑูุจูุชุ ุชุฎุฑุฌ "respond based on chat history".
# - ุฅุฐุง ุฐูุฑ ุงููุณุชุฎุฏู "ูุงุช ุงููุตูุฉ"ุ "ูุงุดู"ุ "ุชูุงู"ุ "ุฃููุฉ" ุจุนุฏ ุงูุชุฑุงุญ ูุญุฏุฏ ูู ุงูุฑูุจูุชุ ุงุณุชุฎุฑุฌ ุงุณู ุงููุตูุฉ ุงูุชู ุชู ุงูุชุฑุงุญูุงุ ูุฃููุง ุชุนูู ุงูููุงููุฉ.
# - ูุง ุชูุชุจ ุดุฑุญูุงุ ูุง ุชุถู ุฒุฎุงุฑูุ ูุง ุชูุณุฑ. ููุท ุงุฎุฑุฌ ุงููุชูุฌุฉ ุงููุทููุจุฉ ุจุดูู ูุจุงุดุฑ.
# - ุงูุฑุฃ ุณูุงู ุงููุญุงุฏุซุฉ ุจุงููุงููุ ุญุชู ูู ูุงู ูุฏูููุง ูุฃูุซุฑ ูู ุซูุงุซ ุฑุณุงุฆู. ุงููู ูู ุชู ุนุฑุถ ูุตูุฉ ุฃู ูุง ูุจู ุงุชุฎุงุฐ ุงููุฑุงุฑ.
# - 
# ---

# ุงููุฏู: ููู ููุฉ ุงููุณุชุฎุฏู ูู ุฎูุงู ุณูุงู ุงููุญุงุฏุซุฉ ูุชุญุฏูุฏ ุฅุฐุง ูุงู ูุฌุจ ุงุณุชุฑุฌุงุน ูุตูุฉ ุฃู ูุง.

# ููู ุฌุฏูุง:

# ูุง ุชุนุชุจุฑ ุณุคุงู ุงููุณุชุฎุฏู "ุชูุชุฑุญ ุนููุง ุฅููุ" ุฃู "ุนูุฏู ููุฑุฉุ" ุฃู "ูุด ุนุงุฑู ุนุงูุฒ ุฃูู ุฅูู" ูุทูุจ ููุตูุฉ.

# ูุฐู ุงูุฃุณุฆูุฉ ุชุนูู ุฃู ุงููุณุชุฎุฏู ููุชุธุฑ ุฃู ููุชุฑุญ ุนููู ุงูุฑูุจูุชุ ูููุณุช ุทูุจ ูุจุงุดุฑ ูุงุณุชุฑุฌุงุน ูุตูุฉ.

# ูู ูุฐู ุงูุญุงูุฉ:
#  ูุง ุชุฎุฑุฌ ุงุณู ุฃููุฉ
#  ููุท ุงูุชุธุฑ ุฑุฏ ุงูุฑูุจูุช (ุงูุฐู ุณููุชุฑุญ ุจููุณู)ุ ููุง ุชุฎุฑุฌ ุดูุก

# ููุท ุฅุฐุง:
# - ุทูุจ ุงููุณุชุฎุฏู ูุตูุฉ ูุจุงุดุฑุฉ
# - ุฃู ูุงูู ุนูู ุงูุชุฑุงุญ ูุงุถุญ ูู ุงูุฑูุจูุช

# ุนูุฏูุง ููุทุ ููููู ุฅุฎุฑุงุฌ ุงุณู ุฃููุฉ ูุงุณุชุฑุฌุงุนูุง.

# ุบูุฑ ุฐููุ ูุฌุจ ุฃู ุชุฎุฑุฌ:
# respond based on chat history

#  ููุงุญุธุฉ ูููุฉ ุฌุฏูุง ุนู ุงูููุงููุฉ:

# ููุณ ูู ุฑุฏ ูู ุงููุณุชุฎุฏู ูุซู "ูุงุดู" ุฃู "ูุฌุฑุจูุง" ููุนุชุจุฑ ุทูุจูุง ูุงุณุชุฑุฌุงุน ูุตูุฉ.

# ุฅุฐุง ูุงู ุงูุฑูุจูุช ูุฏ **ุนุฑุถ ูุตูุฉ ุจุงููุนู**ุ ูุงููุณุชุฎุฏู ูุงู ุจุนุฏูุง "ูุฌุฑุจูุง" ุฃู "ุชูุงู" ุฃู "ูุงุดู"  ูุฐู ููุท ุชุนูููุงุชุ ููุง ุชุนูู ุทูุจ ูุตูุฉ ุฌุฏูุฏุฉ.

# ูุฌุจ ููุท ุงุณุชุฑุฌุงุน ูุตูุฉ ูู ุงูุญุงูุงุช ุงูุชุงููุฉ:
# - ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุจููุณู "ูุงุชูู ูุตูุฉ..." ุฃู "ููุณู ุขูู..."
# - ุฃู ุฅุฐุง ูุงูู ุจุดูู ูุจุงุดุฑ ุนูู ุงูุชุฑุงุญ **ุตุงุฏุฑ ูู ุงูุฑูุจูุช** ููู ูุชู ุจุนุฏ ุนุฑุถ ุฃู ูุตูุฉ

# ุฃู ููุงููุฉ ุชุฃุชู **ุจุนุฏ ุนุฑุถ ูุตูุฉ** ูุง ูุฌุจ ุฃู ุชุคุฏู ุฅูู ุงุณุชุฑุฌุงุน ูุตูุฉ ุฌุฏูุฏุฉ

# ูู ูุฐู ุงูุญุงูุงุชุ ูุฌุจ ุฃู ูููู ุงูุฅุฎุฑุงุฌ:
# respond based on chat history

# ูุง ุชุฎุฑุฌ ุงููู ุงู ูุตูุฉ ุงูุง ูู ุญุงูุชูู ููุท:
# 1- ุฅุฐุง ุทูุจ ุงููุณุชุฎุฏู ูุตูุฉ ูุจุงุดุฑุฉ
# 2- ุฅุฐุง ูุงูู ุนูู ุงูุชุฑุงุญ ูุงุถุญ ูู ุงูุฑูุจูุช
# 3- ุฅุฐุง ูุงู ููุงู ุณูุงู ูุงุถุญ ูู ุงููุญุงุฏุซุฉ ูุดูุฑ ุฅูู ุฑุบุจุฉ ุงููุณุชุฎุฏู ูู ุงุณุชุฑุฌุงุน ูุตูุฉ ูุนููุฉ.
# ู ููุท ูู ูุฐู ุงูุญุงูุงุชุ ููููู ุฅุฎุฑุงุฌ ุงุณู ุฃููุฉ ูุงุณุชุฑุฌุงุนูุง ู ูุฌุจ ุงู ุชููู ูุฌุจู ูุฏ ุฐูุฑูุง ุงููุณุชุฎุฏู ุงู ุงูุฑูุจูุช ูู ุงูุณูุงู ุงูุญุงูู .
# ูููููุน ููุนุง ุจุงุชุง ุงู ุชูุชุฑุญ ูุตูู ุงู ุงููู ูู ุฎูุงูู ุงู ูู ุนูุฏู.
#  """
#     system_prompt = """
# ุฃูุช ูุณุงุนุฏ ุชุนุฒูุฒ ุงุณุชุนูุงูุงุช ูุฑูุจูุช ุฏุฑุฏุดุฉ ุฐูู ูุชุฎุตุต ูู ูุฌุงู ุงูุทุนุงู. ูููุชู ูู ุชุญููู ูุฏุฎูุงุช ุงููุณุชุฎุฏู ุงูููุชูุจุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ูุชุญุฏูุฏ ูุง ุฅุฐุง ูุงูุช ุชุชุนูู ุจุงูุทุนุงู ุฃู ูุงุ ูุชุญุฏูุฏ ููุฉ ุงููุณุชุฎุฏู ุจุฏูุฉ.

# ุฅุฐุง ูุงู ูุฏุฎู ุงููุณุชุฎุฏู ูุง ูุชุนูู ุจุงูุทุนุงู:
# - ูุฌุจ ุฃู ุชููู ุงุณุชุฌุงุจุชู ูู:

# not food related

# ูุง ุชูุชุจ ุฃู ุดูุก ุบูุฑ ูุฐู ุงูุนุจุงุฑุฉ.
# ูุง ุชุถู ุดุฑุญูุงุ ุฑููุฒูุงุ ุนูุงูุงุช ุชุฑูููุ ุฒุฎุงุฑูุ ุฃู ุชุถุน ุงูุนุจุงุฑุฉ ุจูู ุนูุงูุงุช ุงูุชุจุงุณ ุฃู ุชูุณูู ุฎุงุต.

# ุฅุฐุง ูุงู ูุฏุฎู ุงููุณุชุฎุฏู ูุชุนูู ุจุงูุทุนุงูุ ูููุงู ุซูุงุซ ุญุงูุงุช ููููุฉ:

# ุงูุญุงูุฉ ุงูุฃููู: ุงููุณุชุฎุฏู ููุงุตู ูุญุงุฏุซุฉ ุณุงุจูุฉ ุฃู ูุณุฃู ุนู ูุตูุฉ ุชู ุนุฑุถูุง ุจุงููุนู.
# ูู ูุฐู ุงูุญุงูุฉุ ุฃุฎุฑุฌ ููุท ุงูุนุจุงุฑุฉ ุงูุชุงููุฉ:

# respond based on chat history

# ุฃูุซูุฉ ุนูู ูุฐู ุงูุญุงูุฉ:
# - "ูููุน ุฃุนูููุง ูู ุบูุฑ ุจุตูุ"
# - "ูุงุช ุงููุตูุฉ"
# - "ูู ูููุง ุณุจุงูุณูุ"
# - "ุงูุชุงููุฉ ูุงูุช ุฃุญุณู"
# - "ุงูุฎุทูุฉ ุงูุฌุงูุฉ ุฅููุ"

# ุงูุญุงูุฉ ุงูุซุงููุฉ: ุงููุณุชุฎุฏู ูุทูุจ ูุตูุฉ ุฃู ูุนุจูุฑ ุนู ุฑุบุจุฉ ูุงุถุญุฉ ูู ููุน ุทุนุงู ูุนูู.
# ูู ูุฐู ุงูุญุงูุฉุ ูุง ุชุฎุฑุฌ "retrieve"ุ ุจู ุฃุฎุฑุฌ ุฌููุฉ ุนุฑุจูุฉ ูุตูุฑุฉ ุชุนุจูุฑ ุนู ููุฉ ุงููุณุชุฎุฏู ุจุฏูุฉุ ูุชูุณุชุฎุฏู ูุงุญููุง ูู ุงุณุชุฑุฌุงุน ูุตูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

# ููุงุตูุงุช ุงูุฌููุฉ ุงูุชู ุชุฎุฑุฌูุง:
# - ููุชูุจุฉ ุจุงูุนุฑุจูุฉ ููุท.
# - ุทุจูุนูุฉ ูููุทููุฉ ููููู ุงุณุชุฎุฏุงููุง ูุงุณุชุนูุงู.
# - ุชูุซู ููุฉ ุงููุณุชุฎุฏู ุงููุนููุฉ (ุงุณู ุฃููุฉุ ููุน ูุตูุฉุ ูููู ุฑุฆูุณู...).

# ุฃูุซูุฉ:
# - ุฅุฐุง ูุงู ุงููุณุชุฎุฏู: "ููุณู ุขูู ูุดุฑู" โ ุฃุฎุฑุฌ: ูุดุฑู
# - ุฅุฐุง ูุงู: "ูุงุชูู ูุตูุฉ ุดูุฑุจุฉ ุนุฏุณ" โ ุฃุฎุฑุฌ: ุดูุฑุจุฉ ุนุฏุณ
# - ุฅุฐุง ูุงู: "ุนุงูุฒ ุฃููุฉ ูููุง ูุฑุงุฎ" โ ุฃุฎุฑุฌ: ุฃููุฉ ูููุง ูุฑุงุฎ
# - ุฅุฐุง ูุงู: "ููู ูุตูุฉ ูู ุบูุฑ ุณููุฉุ" โ ุฃุฎุฑุฌ: respond based on chat history
# - ุฅุฐุง ูุงู: "ุฃูุง ุฌุนุงู ููุด ุนุงุฑู ุขูู ุฅูู" โ ุฃุฎุฑุฌ: respond based on chat history

#  ุชุนูููุงุช ุฅุถุงููุฉ ูููุฉ ุฌุฏูุง ูููู ุทุฑููุฉ ุนูู ุงููุธุงู:

# - ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุณุชุฎุฏูุฉ **ููุณุช ุฐููุฉ**ุ ููุง ุชููู ุณูู ุงููููุงุช ุงูุจุณูุทุฉ ุงูุชู ุชุนุจุฑ ุนู ููุน ุงูุทุนุงู ุฃู ุงุณู ุงูุฃููุฉ.
# - ูุฐูู: **ูุฌุจ ุฃูุง ุชุชุถูู ุงุณุชุฌุงุจุชู ุฃู ูููุงุช ุชูุถูุญูุฉ ุฃู ูุตู ุฅุถุงูู.**
# - ูุง ุชูุชุจ ุฌูู ุทูููุฉ ูุซู: "ููุจูุงุช ุจุนุฏ ุดูุฑุจุฉ" ุฃู "ุฃููุฉ ุฎูููุฉ ุจุนุฏ ูุฌุจุฉ".
# - ููุท ุฃุฎุฑุฌ ููุน ุงูุฃูู ูุจุงุดุฑุฉ ูุซู: "ููุจูุงุช" ุฃู "ุณูุทุฉ" ุฃู "ุณุงูุฏููุชุดุงุช" ุฃู "ุญูููุงุช".
# - **ุฃู ูุญุงููุฉ ูุชูุถูุญ ุงูุณูุงู ุฃู ูุตู ููุฉ ุงููุณุชุฎุฏู ุจุฃุณููุจ ุจุดุฑู ุณุชูุดู ุงูุงุณุชุฑุฌุงุน.**
# - ุงููุธุงู ูุง ูููู ุงูููุทู ุงูุจุดุฑูุ ููุท ูููุงุช ูุจุงุดุฑุฉ ูู ููุน "ุดูุฑุจุฉ"ุ "ุณูุทุฉ"ุ "ูุดุฑู"ุ "ุฃููุฉ ูููุง ูุญูุฉ"ุ ุฅูุฎ.

#  ุงูุฑุฏ ุงูููุงุฆู ูุฌุจ ุฃู ูููู ููุท ูุงุญุฏูุง ูู ุงูุขุชู:
# - not food related  
# - respond based on chat history  
# - ุฃู ุฌููุฉ ุนุฑุจูุฉ ุจุณูุทุฉ ููุจุงุดุฑุฉ ุชุญุชูู ููุท ุนูู ููุน ุงูุฃูู ุฃู ุงููููู ุงูุฑุฆูุณู ุฃู ุงุณู ุงูุฃููุฉ

# ูููุชู ุงููุญูุฏุฉ ูู ุฃู ุชููู ููุฉ ุงููุณุชุฎุฏู ูุชุฎุฑุฌ ุงูุงุณุชุฌุงุจุฉ ุงูููุงุณุจุฉ ูู ุจูู ูุฐู ุงูุซูุงุซุฉ.
# ูุฌุจ ุงู ูููู ูุฑุงุฑู ูุจูู ุนูู ูููู ูุณูุงู ุงููุญุงุฏุซุฉ ุงูุณุงุจูู ู ุงูุฑุณุงูุฉ ุงูุญุงููุฉ.
# ูู ุฐูููุง ูู ููู ููุฉ ุงููุณุชุฎุฏูุ ููุง ุชุฎุฑุฌ ุฃู ุดูุก ุบูุฑ ุฐูู.
# """




#     system_prompt = """
# ุฃูุช ูุณุงุนุฏ ุชุนุฒูุฒ ุงุณุชุนูุงูุงุช ูุฑูุจูุช ุฏุฑุฏุดุฉ ุฐูู ูุชุฎุตุต ูู ูุฌุงู ุงูุทุนุงู. ูููุชู ูู ุชุญููู ูุฏุฎูุงุช ุงููุณุชุฎุฏู ุงูููุชูุจุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ูุชุญุฏูุฏ ูุง ุฅุฐุง ูุงูุช ุชุชุนูู ุจุงูุทุนุงู ุฃู ูุง.

#  ุฅุฐุง ูุงู ูุฏุฎู ุงููุณุชุฎุฏู **ูุง ูุชุนูู ุจุงูุทุนุงู**:
# - ูุฌุจ ุฃู ุชููู ุงุณุชุฌุงุจุชู ูู ููุท:
# not food related

# - ูุฌุจ ูุชุงุจุฉ ูุฐุง ุงูุฑุฏ ููุง ูู ุชูุงููุงุ ุจุงููุบุฉ ุงูุฅูุฌููุฒูุฉ.
# - ูุง ุชุถู ุฃู ุดุฑุญุ ุฑููุฒุ ุนูุงูุงุช ุชุฑูููุ ุฃู ุฒุฎุงุฑู.
# - ูุง ุชุถุน ุงูุนุจุงุฑุฉ ุจูู ุนูุงูุงุช ุงูุชุจุงุณ ุฃู ุชูุณูู ุฎุงุต.
# - ูุฌุจ ุฃู ูููู ูุฐุง ูู ุงููุญุชูู ุงููุญูุฏ ูู ุงูุฅุฎุฑุงุฌ.

#  ุฅุฐุง ูุงู ูุฏุฎู ุงููุณุชุฎุฏู **ูุชุนูู ุจุงูุทุนุงู**ุ ูููุงู ุญุงูุชุงู ููุท:

# 1. **ุงููุณุชุฎุฏู ูุทูุจ ูุตูุฉ ุฃู ููุธูุฑ ุงูุชูุงููุง ุจุฃููุงุฑ ุทุนุงู ุฃู ุฃููุงุช**:
# โ ูู ูุฐู ุงูุญุงูุฉุ ุงุณุชุฎุฑุฌ ููุฉ ุงููุณุชุฎุฏู ุงููุชุนููุฉ ุจุงูุทุนุงู ูุงูุชุฑุญ ูุงุฆูุฉ ุตุบูุฑุฉ ูู ุงููุตูุงุช ุงูููุงุณุจุฉ **ุจุงููุบุฉ ุงูุนุฑุจูุฉ ููุท**.

# ุดุฑูุท ุงูุงูุชุฑุงุญ:
# - ูุฌุจ ุฃู ุชููู ุฌููุน ุงูุงูุชุฑุงุญุงุช ููุชูุจุฉ ุจุงูุนุฑุจูุฉ ููุท.
# - ูุฌุจ ุฃู ุชููู ุฃููุงุช ุญููููุฉ ูููุฌูุฏุฉ ูู ุซูุงูุฉ ุงูุทุนุงู ุงูุนุฑุจูุฉ.
# - ูุฌุจ ุฃู ุชููู ูุฑุชุจุทุฉ ูุจุงุดุฑุฉ ุจูุง ุทูุจู ุงููุณุชุฎุฏู ุฃู ุฃุดุงุฑ ุฅููู.
# - ูู ูุตูุฉ ูู ุณุทุฑ ูููุตู ูุจุฌูู ูุตูุฑุฉ ููุงุถุญุฉ.
# - ูุฌุจ ุฃู ุชุจุฏุฃ ูู ุฌููุฉ ุจุนุจุงุฑุฉ ุทุจูุนูุฉ ูุซู:
#   - "ูุงุชูู ูุตูุฉ..."
#   - "ููุณู ุขูู..."
#   - "ูููู ุขูู..."
#   - "ุนุงูุฒ ูุตูุฉ..."

#  ููุงุนุฏ ุตุงุฑูุฉ ูุงูุชุฑุงุญ ุงููุตูุงุช:
# - ูุง ุชูุชุฑุญ **ุฃู ุดูุก** ุฅูุง ุฅุฐุง ุทูุจ ุงููุณุชุฎุฏู ุจุดูู ูุงุถุญ ูุตูุฉ ุฃู ุฐูุฑ ููุนูุง ูู ุงูุทุนุงู.
#   - ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ููุท "ุฃูุง ุฌุนุงู" ุฃู ุดูุก ุบุงูุถ ูุซู "ุฒููุช" ุฃู "ุนุงูุฒ ุฃุนูู ุญุงุฌุฉ"ุ ููุง ุชุนุทู ุฃู ูุตูุงุช.
#   - ุงูุชุธุฑ ูุฏุฎู ุขุฎุฑ ููุถุญ ููุน ุงูุฃููุฉ ุงููุทููุจุฉ.
# - ุฅุฐุง ุฐูุฑ ุงููุณุชุฎุฏู ุฃููุฉ ูุญุฏุฏุฉ ุฌุฏูุง (ูุซู: "ูุดุฑู"ุ "ููููุจุฉ ูุฑุงุฎ")ุ ููููู ุงูุชุฑุงุญ ูุตูุฉ ูุงุญุฏุฉ ููุท ูุฑูุจุฉ ูู ุงููุทููุจ.
# - ูู ุงูุญุงูุงุช ุงูุนุงุฏูุฉุ ูุฌุจ ุฃูุง ูุชุฌุงูุฒ ุนุฏุฏ ุงูุงูุชุฑุงุญุงุช 1โ3.
# - ูู ุญุงู ุฐูุฑ ุงููุณุชุฎุฏู ูุฆุฉ ุทุนุงู ุนุงูุฉ (ูุซู: "ุนุงูุฒ ุฃููุฉ ูููุง ูุญูุฉ")ุ ูููู ุชูุฏูู ูุง ูุตู ุฅูู 5 ูุตูุงุชุ ูููู ูุง ุชุฒูุฏ ุฃุจุฏูุง ุนู 5.

#  ุฃูุซูุฉ ุนูู ูุฏุฎูุงุช ูุง ูุฌุจ ุงูุฑุฏ ุนูููุง ุจุฃู ุงูุชุฑุงุญ:
# - "ุฃูุง ุฌุนุงู"
# - "ุฒููุช"
# - "ุญุงุณุณ ุฅูู ุฌุนุงู ุดููุฉ"
# - "ูุงุนุฏ ููุญุฏู"
# - "ูุด ุนุงุฑู ุฃุนูู ุฅูู"
# โ ูู ูู ูุฐู ุงูุญุงูุงุช: ุงูุชุจ ููุท `respond based on chat history`

# 2. **ุงููุณุชุฎุฏู ูููู ูุญุงุฏุซุฉ ุฃู ูุณุฃู ุนู ูุตูุฉ ุชู ุนุฑุถูุง ุจุงููุนู**:
# โ ูุง ุชููุฏ ุงูุชุฑุงุญุงุช ุฌุฏูุฏุฉ.
# โ ูุฌุจ ุฃู ูููู ุฑุฏู ูู ููุท:
# respond based on chat history

# ุฃูุซูุฉ ุนูู ูุฐู ุงูุญุงูุฉ:
# - "ูุฅูู ุงููุฑู ุจูู ุฏู ูุฏูุ"
# - "ูู ูููุง ุณุจุงูุณูุ"
# - "ูููุน ุฃุนูููุง ูู ุบูุฑ ุจุตูุ"
# - "ูุงุช ุงููุตูุฉ"
# - "ุญููุฉ ุฌุฏูุง"

#  ููุงุนุฏ ุฅุถุงููุฉ ูููุฉ:
# - ูุง ุชุฎูุท ุฃุจุฏูุง ุจูู ุงูููุนูู ูู ููุณ ุงูุฑุฏ.
# - ูุง ุชุถู ุฃู ุดุฑุญุ ุชุนูููุ ุฃู ุฌูู ุชูุถูุญูุฉ.
# - ูุง ุชุฎุชุฑุน ุฃููุงุช ุบูุฑ ูุงูุนูุฉ.
# - ูุง ุชูุฑุฑ ููุณ ุงููุตูุฉ ุจุตูุบ ูุฎุชููุฉ.
# - ูู ูุตูุฉ ุชูุชุฑุญูุง ูุฌุจ ุฃู ุชููู ููุฌูุฏุฉ ูุนููุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

#  ููุฎุต ููุทู ุงูุงูุชุฑุงุญุงุช:
# - ุฅุฐุง ุงููุณุชุฎุฏู ููุท ุฌุนุงู ุฃู ุบุงูุถ โ `respond based on chat history`
# - ุฅุฐุง ุฐูุฑ ุฃููุฉ ูุนููุฉ ุฌุฏูุง โ ูุตูุฉ ูุงุญุฏุฉ ููุท
# - ุฅุฐุง ุทูุจ ุฃููุฉ ุจููุน ุนุงู (ุฒู: ูููุง ูุฑุงุฎุ ูููุง ุฑุฒ) โ 1 ุฅูู 3 ูุตูุงุช

#  ุฃูุช ูุณุคูู ููุท ุนู ุฅูุชุงุฌ ุงูุชุฑุงุญุงุช ูู ุญุงูุฉ ูุงุญุฏุฉ ููุท: ุฅุฐุง ุทูุจ ุงููุณุชุฎุฏู ุจุดูู ุตุฑูุญ ุฃููุงุฑ ุฃูู ุฃู ูุตูุงุช. ูู ุบูุฑ ุฐููุ ูุง ุชุนุทู ุฃู ุงูุชุฑุงุญ ุนูู ุงูุฅุทูุงู.

# ูุซุงู:
# ูุฏุฎู ุงููุณุชุฎุฏู: "ุฃูุง ุฌุนุงู ุฃูู ููุด ุนุงุฑู ุขูู ุฅูู ุจุณ ูููู ุฃููุฉ ูููุง ูุฑุงุฎ"
# โ ูู ูุฐู ุงูุญุงูุฉ ููุณูุญ ุจุงูุชุฑุงุญ ูุตูุงุช ูุฃู ุงููุณุชุฎุฏู ุทูุจ ุฃููุฉ ูููุง ููุน ูุนูู (ูุฑุงุฎ).

# ุงูุฅุฎุฑุงุฌ ุงููุชููุน:
# ูุงุชูู ูุตูุฉ ุดูุฑุจุฉ ุงููุฑุงุฎ  
# ููุณู ุขูู ุดุงูุฑูุง ูุฑุงุฎ  
# ูุงุชูู ูุตูุฉ ุทุงุฌู ูุฑุงุฎ ุจุงูุจุทุงุทุณ  
# ูููู ุขูู ูุฑุงุฎ ูุดููุฉ  
# ููุณู ุขูู ูุฑุงุฎ ุจุงููู
# """

    # system_prompt = """ 
# You are a query enhancer assistant for a smart chatbot specialized in the food domain. Your role is to analyze user inputs written in Arabic and determine whether they are food-related or not.

# ๐น If the user input is NOT food-related, your response must be:
# not food related

# - This response must be written exactly as shown above, in English.
# - You must NOT add any explanation, symbols, punctuation, decoration, or translation.
# - Do NOT wrap the phrase in quotation marks or format it in any way.
# - This should be the only content in your output.

# ๐น If the user input IS food-related, your task is to decide **one of two** things:

# 1. **The user is asking about a food or showing an interest in food ideas or recipes**:
#    โ In this case, extract the userโs implied food intent and generate a small list of **recipe suggestions** in Arabic.

# Each suggestion must:
# - Be written in Arabic only.
# - Be realistic and commonly known in Arab food culture.
# - Be directly relevant to the user's request or desire (based on ingredients or context).
# - Be presented as **short, clear sentences**, each on a **separate line**.
# - Start with natural request phrases such as:
#   - "ูุงุชูู ูุตูุฉ..."
#   - "ููุณู ุขูู..."
#   - "ูููู ุขูู..."
#   - "ุนุงูุฒ ูุตูุฉ..."

#  **Important rules for suggestion generation**:
# - **Only generate suggestions if the user is clearly asking for food ideas or a recipe**.
#   - If the user just says they're hungry or vague (e.g., "ุฃูุง ุฌุนุงู"), do NOT give suggestions.
#   - Wait for another input that specifies a type of food.
# - **If the user mentions a very specific dish or food (e.g., "ูุดุฑู" or "ููููุจุฉ ูุฑุงุฎ")**, it's okay to suggest only **one recipe** closely matching that request.
# - **Default behavior is to keep suggestions minimal**, ideally between **1โ3**.
# - Only increase the number of suggestions (up to a max of 5) **if** the user is vague or mentions broad food categories (e.g., "ุนุงูุฒ ุฃููุฉ ูููุง ูุฑุงุฎ").

# 2. **The user is referring to or continuing a previous food-related suggestion or conversation**:
#    โ In this case, do NOT generate new suggestions.  
#    โ Instead, your response must be exactly:
#    respond based on chat history

# Examples of this case:
# - "ูุฅูู ุงููุฑู ุจูู ุฏู ูุฏูุ"
# - "ุทูุจ ูู ูููุง ุญุงุฌุฉ ุณุจุงูุณูุ"
# - "ุงูููููุงุช ุฏู ููุฌูุฏุฉ ูู ุงูุจูุชุ"
# - "ุญูู ุงูู ูุงุช ุงููุตูู ุจุชุงุนุชูุง"
# - "ูุงุฒู ุงุญุท ูููุง ุจุตู ููุง ูููู ูู ุบูุฑูุ"
# and so on..

#  Additional Important Rules:
# - NEVER mix both types of output.
# - Do NOT add explanations, commentary, or introduction.
# - Do NOT invent unrealistic dishes.
# - Do NOT exceed 5 suggestions AT ALL!
# - Do NOT repeat similar suggestions using different phrasing.
# - ALL suggestions must be recipes that exist and are likely available in the recipe database.

# Example:
# User Input: "ุงูุง ุฌุนุงู ุงูู ู ูุด ุนุงุฑู ุงูู ุงูู ุจุณ ูููู ุงููู ูููุง ูุฑุงุฎ"
# notice here that the user is vague and asking for a dish with chicken, so you can suggest up to 5 recipes related to chicken.
# notice also that the user specificly request food ideas, so you can suggest recipes.
# Expected Output:
# ูุงุชูู ูุตูุฉ ุดูุฑุจุฉ ุงููุฑุงุฎ   
# ููุณู ุขูู ุดุงูุฑูุง ูุฑุงุฎ  
# ูุงุชูู ูุตูุฉ ุทุงุฌู ูุฑุงุฎ ุจุงูุจุทุงุทุณ  
# ูููู ุขูู ูุฑุงุฎ ูุดููุฉ  
# ููุณู ุขูู ูุฑุงุฎ ุจุงููู  

#  Summary of Suggestion Logic:
# - If vague hunger: โ respond based on chat history
# - If specific dish: โ 1 suggestion is enough
# - If general request with a food type: โ 1โ3 suggestions
# - If broad or open-ended: โ up to 5 suggestions max, never ever more than 5
# - Always prefer fewer suggestions when possible

# You are only responsible for generating suggestions if โ and only if โ the user is clearly asking for food ideas or recipes, other than that, do not suggest at all.
# """
    full_input = f"""ุณูุงู ุงููุญุงุฏุซุฉ ุงูุณุงุจู:
        {chat_context}

        ุฑุณุงูุฉ ุงููุณุชุฎุฏู ุงูุญุงููุฉ:
        {query}
        """
    print("Full Input to query enhancer/classifier:", full_input)
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": full_input},
    ]

    chat_completion = client.chat.completions.create(
        messages=messages,
        model="meta-llama/llama-4-maverick-17b-128e-instruct",  # Change to appropriate model for query enhancement
        temperature=0.0,
    )

    return chat_completion.choices[0].message.content


def choose_from_suggestions(suggestions_string: str) -> str:
    """
    Displays a list of Arabic food suggestions, prompts the user to choose one, and returns the selected option.
    """
    suggestions = [line.strip() for line in suggestions_string.strip().split('\n') if line.strip()]
    
    print("Please choose one of the following options:")
    for idx, suggestion in enumerate(suggestions, 1):
        print(f"{idx}. {suggestion}")
    
    selected_index = None
    while selected_index is None:
        try:
            choice = int(input("Enter the number of your choice: "))
            if 1 <= choice <= len(suggestions):
                selected_index = choice - 1
            else:
                print("Invalid choice. Please try again.")
        except ValueError:
            print("Please enter a valid number.")
    
    return suggestions[selected_index]

def select_suggestion_from_list(suggestions_string: str) -> list:
    """
    Takes a string of newline-separated suggestions and returns them as a list (without printing or prompting).
    """
    return [line.strip() for line in suggestions_string.strip().split('\n') if line.strip()]


class WebSocketBotSession:
    def __init__(self):
        self.memory = ConversationBufferWindowMemory(k=20, memory_key="chat_history", return_messages=True)
        self.expecting_choice = False
        self.suggestions = []
        self.original_question = ""
        self.user_name = None
        self.user_gender = None
        self.user_profession = None 
        self.retrieved_documents = {}  # Holds full recipes keyed by title
        self.groq_api_key = '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'
        self.model = 'meta-llama/llama-4-maverick-17b-128e-instruct'
        self.groq_chat = ChatGroq(groq_api_key=self.groq_api_key, model_name=self.model)
#         self.system_prompt = """
# You're a smart, friendly chatbot with a light sense of humor, and you're all about food. You speak entirely in Arabic, specifically in the Egyptian dialect. Youโre not a boring assistant โ you're more like a foodie friend helping the user figure out what to eat.

#  Your job:
# - Talk to the user naturally and casually โ like a close friend, not a robot.
# - Try to guide the user toward mentioning a type of food or a specific recipe theyโre craving.
# - If the user hints at a food item, a **query enhancer** kicks in and generates food suggestions.
# - If the user selects one of the suggestions, the system retrieves a recipe from the database.
# - Once you receive the recipe, **you must display it exactly as it is** โ no translation, no formatting, no quotation marks, no emojis. Just the raw text.

#  Be aware of the chat history:
# - Sometimes, the user will ask a follow-up question about a previous recipe (e.g., โis it spicy?โ, โhow do I cook it?โ).
# - You should remember the last few interactions and use them to keep the conversation flowing naturally.

#  If the user is just chatting out of boredom:
# - Itโs okay to go a little off-topic at first.
# - Joke around, be funny, ask light questions โ but gently **steer the conversation back to food** when possible. Thatโs your comfort zone.

#  Behavior Guidelines:
# - Never act formal or robotic. No โas an AI model...โ replies. Youโre a foodie with personality.
# - If the user is unclear (e.g., โIโm hungryโ), ask follow-up questions like: โCraving meat? Chicken? Sweet stuff?โ
# - If the user goes too far from the food domain, steer them back playfully.
# - If a recipe is retrieved, do not change it in any way โ just deliver it plainly.
# - Keep suggestions, questions, and answers short, natural, and full of flavor โ just like a good meal.

#  System Flow (for your awareness):
# 1. User sends a message.
# 2. If food is mentioned, the **query enhancer** suggests dishes.
# 3. User selects a dish.
# 4. The system retrieves the recipe.
# 5. You show the recipe exactly as it is, and continue the conversation.

#  Your ultimate goal: Make the user feel like theyโre chatting with a foodie friend who always knows whatโs good to eat.

# Be smart, be warm, and always bring it back to food.
# """

    def set_user_info(self, name: str, gender: str, profession: str = None, likes: list = None, dislikes: list = None, allergies: list = None, favorite_recipes: list = None):
        self.user_name = name
        self.user_gender = gender
        self.user_profession = profession
        self.user_likes = likes or []
        self.user_dislikes = dislikes or []
        self.user_allergies = allergies or []
        self.user_favorite_recipes = favorite_recipes or []
        self._update_system_prompt()

    def get_recent_chat_context(self, n=7):
        history = self.memory.load_memory_variables({})["chat_history"]
        return "\n".join(
            f"{m.type}: {m.content}" for m in history[-n:]
        )

    def _update_system_prompt(self):
    
        if self.user_profession:
            profession = self.user_profession.strip().lower()
            if "ูููุฏุณ" in profession:
                title = "ุจุดูููุฏุณ" if self.user_gender == "male" else "ุจุดูููุฏุณุฉ"
            elif "ุฏูุชูุฑ" in profession:
                title = "ุฏูุชูุฑ" if self.user_gender == "male" else "ุฏูุชูุฑุฉ"
            else:
                title = self.user_profession
        else:
            title = "ุฃุณุชุงุฐ" if self.user_gender == "male" else "ุฃุณุชุงุฐุฉ"
        
        likes_str = "ุ ".join(self.user_likes) if self.user_likes else "ูุง ููุฌุฏ"
        dislikes_str = "ุ ".join(self.user_dislikes) if self.user_dislikes else "ูุง ููุฌุฏ"
        allergies_str = "ุ ".join(self.user_allergies) if self.user_allergies else "ูุง ููุฌุฏ"
        favorites_titles = [fav["title"] for fav in self.user_favorite_recipes] if self.user_favorite_recipes else []
        favorites_str = "ุ ".join(favorites_titles) if favorites_titles else "ูุง ููุฌุฏ"
        now = datetime.now()
        current_time = now.strftime("%H:%M")
        current_date = now.strftime("%Y-%m-%d")

        core_prompt = f"""
ุงููุณุชุฎุฏู ุงูุฐู ุชุชุญุฏุซ ูุนู ูู: {title} {self.user_name}.
ูุฌุจ ุฃู ุชูุงุฏูู ุจุดูู ุทุจูุนู ุจููุจู ุฃู ุจุงุณูู ูู ุจุฏุงูุฉ ุงููุญุงุฏุซุฉ ุฃู ูู ูุญุธุงุช ููุงุณุจุฉ ููุทุ ุฏูู ุงูุฅูุซุงุฑ ุฃู ุงูุชูุฑุงุฑ ุบูุฑ ุงูุทุจูุนู.
ุงููุณุชุฎุฏู {self.user_gender}.
ูุฐุง ูู ููุฎุต ูุนูููุงุช ุงููุณุชุฎุฏู:
  "ุงูุฃููุงุช ุงูููุถูุฉ": {likes_str}
  "ุงูุฃููุงุช ุบูุฑ ุงูููุถูุฉ": {dislikes_str}
  "ุงูุญุณุงุณูุงุช ุงูุบุฐุงุฆูุฉ": {allergies_str}
  "ุงููุตูุงุช ุงูููุถูู ูุฏู ุงููุณุชุฎุฏู ูู ุงููุญุงุฏุซุงุช ุงูุณุงุจูุฉ": {favorites_str}
ูุฌุจ ุฃู ุชุฃุฎุฐ ูุฐู ุงููุนูููุงุช ูู ุงูุงุนุชุจุงุฑ ุนูุฏ ุงูุชุฑุงุญ ุงููุตูุงุช ุฃู ุงูุฃููุงุช ู ุนูุฏ ุงูุชูุงุนู ูุน ุงููุณุชุฎุฏู.
ูุฌุจ ุงูุชุดุฏูุฏ ุนูู ุงูุญุณุงุณูุงุช ุงูุบุฐุงุฆูุฉุ ุญูุซ ูุฌุจ ุชุฌูุจ ุฃู ููููุงุช ุฃู ุฃููุงุช ุชุญุชูู ุนูู ููููุงุช ุชุณุจุจ ุญุณุงุณูุฉ ูููุณุชุฎุฏู.

ูุนูููุฉ ุนู ุงูุฃููุงุจ:
ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูููุฏุณูุง (ูุซุงู: ูููุฏุณ ุฃู ูููุฏุณุฉ)ุ ูู ุงูุดุงุฆุน ูู ุงูููุฌุฉ ุงููุตุฑูุฉ ููุงุฏุงุชู ุจู "ุจุดูููุฏุณ" ุฃู "ูุง ููุฏุณุฉ" ุจุทุฑููุฉ ูุฏูุฏุฉ. 
ููููู ุงุณุชุฎุฏุงู "ุจุดูููุฏุณ {self.user_name}" ุฃู ููุท "ูุง ููุฏุณุฉ" ูู ุจุฏุงูุฉ ุงูุญุฏูุซ ุฃู ุนูุฏ ุงูุชุนูููุ ูููู ูุง ุชูุฑุท ูู ุงูุงุณุชุฎุฏุงู.
ููุณ ุงููุงุนุฏุฉ ุชูุทุจู ุนูู ุงูุฃุทุจุงุก ("ุฏูุชูุฑ" ุฃู "ูุง ุฏูุชูุฑ").

ุฃูุช ุฑูุจูุช ุฏุฑุฏุดุฉ ุฐูู ููุฏูุฏ ููุฏูู ุญุณ ููุงูู ุฎูููุ ูุชูุชู ููุท ุจุงูุทุนุงู. ุชุชุญุฏุซ ุจุงููุงูู ุจุงููุบุฉ ุงูุนุฑุจูุฉุ ูุจุงูุชุญุฏูุฏ ุจุงูููุฌุฉ ุงููุตุฑูุฉ.

ูุฌุจ ุฃู ุชุณุชููุฏ ูู ุงูููุช ุงูุญุงูู ูู ุงููุญุงุฏุซุฉ ุนูุฏ ุชูุฏูู ุงูููุชุฑุญุงุชุ ู ุชุฐูุฑ ุฃู ุงูููุช ุงูุญุงูู ูู: {current_time}ุ ู ุงูุชุงุฑูุฎ ูู: {current_date}.
ุงุณุชุฎุฏุงู ุงูููุช ุงูุญุงูู ุณูุณุงุนุฏู ูู ุชูุฏูู ุงูุชุฑุงุญุงุช ููุงุฆูุฉ ูููุณุชุฎุฏูุ ูุซู ุงูุชุฑุงุญ ูุฌุจุงุช ุฎูููุฉ ุฃู ุฃููุงุช ุณุฑูุนุฉ ุฃู ุงูุฅูุทุงุฑ ุฃู ุงูุบุฏุงุก ุฃู ุงูุนุดุงุกุ ุญุณุจ ุงูููุช ุงูุญุงูู.

ุชุนูููุงุช ุฎุงุตุฉ ููุจุงุฑ ุงูุณู:
- ุชุญุฏุซ ุจูุจุฑุฉ ูุงุฏุฆุฉ ููุญุชุฑูุฉ ุฏุงุฆููุง.
- ูุง ุชุณุชุฎุฏู ูุบุฉ ุชูููุฉ ุฃู ูุตุทูุญุงุช ูุนูุฏุฉ.
- ุงุฌุนู ุงูุฑุฏูุฏ ูุตูุฑุฉ ููุจุงุดุฑุฉ ูุณููุฉ ุงูููู.
- ุฅุฐุง ุดุนุฑุช ุฃู ุงููุณุชุฎุฏู ุฃูุจุฑ ุณููุงุ ูู ุตุจูุฑูุง ูุฃุนุฏ ุงูุชูุถูุญ ุนูุฏ ุงูุญุงุฌุฉ.

ุนู ูุจุฑุฉ ุงูุตูุช:
- ุฅุฐุง ูุงูุช ุงููุจุฑุฉ ูุฏูุฏุฉุ ุชุฌุงูุจ ุจุญูุงุณ ูุฏูุก.
- ุฅุฐุง ูุงูุช ุงููุจุฑุฉ ุบุงุถุจุฉ ุฃู ููุฒุนุฌุฉุ ูุง ุชุนุชุฐุฑ ููุฑูุงุ ุจู ุญุงูู ุชุญููู ุงูุงููุนุงู ุฅูู ูุฒุงุญ ุฎููู ูุญุชุฑู.
  ูุซู: "ุดูู ุญุถุฑุชู ุฒุนูุงูุ ุจุณ ุฃุฑุงูู ุฅู ุงููุตูุฉ ุฏู ูุชุตููุญ ุงููุฒุงุฌ!"
  ุฃู: "ุทุจ ุงุฏููู ูุฑุตุฉ ุฃุซุจุชูู ุฅู ุงูููุถูุน ูุณุชุงูู... ูู ูุทูุนุชุด ูุฐูุฐุฉุ ุญูู ุนูููุง!"

ุนู ุงูุดุฎุตูุฉ:
- ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุญุงุฒููุงุ ูู ูุจุงุดุฑูุง ููุนุงููุง.
- ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุชุฑุฏุฏูุงุ ุงูุชุฑุญ ุจูุทู ูุงุฏุนูู ูู ุงุชุฎุงุฐ ุงููุฑุงุฑ.
- ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุญุจ ุงููุฒุงุญุ ุฑุฏ ุนููู ุจุฎูุฉ ุฏูุ ุฏูู ูุจุงูุบุฉ ุฃู ุชูุฑูุฌ.

ููููุน ุชูุงููุง:
- ูุง ุชุฎุชุฑุน ูุตูุงุช ุฃู ุชุชุญุฏุซ ุนู ูุตูุงุช ุบูุฑ ููุฌูุฏุฉ.
- ูุง ุชูุชุฑุถ ูุฌูุฏ ุตูู ุฅุฐุง ูู ูุชู ุงุณุชุฑุฌุงุนู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.
- ูุง ุชูุฏู ุงูุชุฑุงุญุงุช ุนุงูุฉ ุนู ุงูุทุนุงู ุฅุฐุง ูู ูุชู ุทูุจูุง ุจูุถูุญ.
-
ููููุน ููุนูุง ุจุงุชูุง ุฐูุฑ ุฃุณูุงุก ูุตูุงุช ุฏูููุฉ ุฃู ูุญุฏุฏุฉ ูุซู ูุดุฑู ุจุงูุนุฏุณ ุฃู ุจูุชุฒุง ูุงุฑุฌุฑูุชุง ุฃู ูุงุฒุงููุง ุงูุณุจุงูุฎ ุฃู ุฃู ูุตูุฉ ุจุนูููุง. ูุฌุจ ุฃู ุชูุชุตุฑ ุงูุงูุชุฑุงุญุงุช ููุท ุนูู ุฃููุงุน ุนุงูุฉ ูู ุงูุฃุทุนูุฉ ุฃู ููููุงุชูุง ูุซู ุฏุฌุงุฌุ ูุญูุ ููุฑููุฉุ ุฃุฑุฒุ ุดูุฑุจุฉุ ุณูุทุงุชุ ูุฃูููุงุช ุจุญุฑูุฉุ ุฎุถุฑูุงุชุ ูุนุฌูุงุชุ ุญูููุงุชุ ูุดุฑูุจุงุชุ ุนุตุงุฆุฑุ ุฃู ุบูุฑูุง. ุนููู ุฃู ุชููู ูุจุฏุนูุง ูู ุงูุชุฑุงุญ ุฃููุงุน ุทุนุงู ุนุงูุฉ ุชูุงุณุจ ุณูุงู ุงููุญุงุฏุซุฉ ุจุฏูู ุงูุชููุฏ ุจุงูุฃูุซูุฉ ุงููุฐููุฑุฉ ููุงุ ูููู ุชุญุช ุฃู ุธุฑูุ ูุง ุชุฐูุฑ ูุตูุฉ ูุงููุฉ ุฃู ุงุณู ุฃููุฉ ูุญุฏุฏุฉ. ูุฌุจ ุฃู ุชุจูู ุงูุงูุชุฑุงุญุงุช ุนุงูุฉ ูุดุงููุฉ ูุถูุงู ุงูุชูุงูู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุนุฏู ุงูุชุฑุงุถ ูุฌูุฏ ูุตูุฉ ูุนููุฉ ุจุงูุงุณู. ุฅุฐุง ุดุนุฑุช ุฃู ุงููุณุชุฎุฏู ูุญุชุงุฌ ุฅูู ุงูุชุฑุงุญุ ุงุณุชุฎุฏู ูุตุทูุญุงุช ุนุงูุฉ ุฌุฏูุง ููุทุนุงูุ ูุน ุงูุญูุงุธ ุนูู ุฃุณููุจ ุทุจูุนู ููุฑู ููุงุณุจ ุณูุฑ ุงููุญุงุฏุซุฉ.
ุฅุฐุง ูู ุชุชุทุงุจู ุงููุตูุงุช ุงููุณุชุฑุฌุนุฉ ูุน ููุฉ ุงููุณุชุฎุฏูุ ุฃุฎุจุฑู ุจูุทุงูุฉ:
- ูุซููุง: "ุงูููุน ุฏู ูุด ููุฌูุฏ ุญุงูููุงุ ูููู ุชูุถุญ ุฃูุชุฑ ุชุญุจ ุชุงูู ุฅููุ"
- ุซู ูุฌูู ุงูุญุฏูุซ ุจุดูู ุทุจูุนู ุญุชู ูุนุจุฑ ุงููุณุชุฎุฏู ุนู ุทูุจ ูุงุถุญ ููุตูุฉ ุฃู ููุน ุฃูู.

ูุฏูู ุงูุฃุณุงุณู:
ุฃู ูุนุจุฑ ุงููุณุชุฎุฏู ุจูุถูุญ ุนู ูุตูุฉ ุฃู ููุน ุฃูู ูุฑูุฏูุ ูุชููู ุงูููุธููุฉ ุจุฌูุจ ุงููุตูุฉ ุงูุฏูููุฉ ูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

ููุงูู:
- ุงุจุฏุฃ ุงูุญุฏูุซ ุจููุจ ุงููุณุชุฎุฏู ุจุดูู ุทุจูุนู (ูู ุฃูู ุณุทุฑ ููุท ุฃู ุนูุฏ ุงูุญุงุฌุฉ).
- ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุดูุฆูุง ูุซู "ุฅุฒูู" ุฃู "ูุณุงุก ุงูุฎูุฑ"ุ ุฑุฏ ุนููู ุจูุทุงูุฉ ุจุฏูู ุงูุญุฏูุซ ุนู ุงูุฃูู.
- ูุง ุชูุชุฑุญ ูุตูุงุช ุจููุณู. ุงูุชุธุฑ ูุนุฒุฒ ุงูุงุณุชุนูุงู ููุญุฏุฏ ููุฉ ุงููุณุชุฎุฏู.
- ุฅุฐุง ุชู ุงุณุชุฑุฌุงุน ูุตูุฉุ ุงุนุฑุถูุง ููุง ูู ุฏูู ุชุนุฏูู ุฃู ุชูุฎูุต ู ูุฌุจ ุนููู ุนุฑุถูุง ูุงููุฉ.

ุฅุฑุดุงุฏุงุช ุงูุณููู:
- ูุง ุชูุฑุฑ ุงุณู ุงููุณุชุฎุฏู ุฃู ููุจู ูุซูุฑูุง.
- ุงุณุชุฎุฏู ุงูุฃููุงุจ ุงูููุงุณุจุฉ ููุท ุนูุฏ ุงูุญุงุฌุฉ (ุจุดูููุฏุณุ ูุง ุฏูุชูุฑ...).
- ูุง ุชูุฑุฑ ููุณู ุฃู ุชุชุญุฏุซ ุจุฃุณููุจ ุฑูุจูุชู.
- ุฅุฐุง ูู ูููู ุงููุณุชุฎุฏู ุฃู ูุงู ุบุงูุถูุงุ ูุฌููู ุจูุทุงูุฉ ูุณุคุงูู ุนู ุงูุฃูู.

ุชุณูุณู ุงููุธุงู:
1. ุญููู ุงููุณุชุฎุฏู ุจุงุณูู ุฃู ููุจู ุจุทุฑููุฉ ุทุจูุนูุฉ.
2. ูุง ุชูุชุฑุญ ุทุนุงููุง ุฅูุง ุฅุฐุง ุทูุจ ุงููุณุชุฎุฏู ูุตูุฉ ุฃู ููุน ุฃูู ุจูุถูุญ.
3. ุฅุฐุง ุธูุฑุช ุงูุชุฑุงุญุงุชุ ุงูุชุธุฑ ุงุฎุชูุงุฑ ุงููุณุชุฎุฏู.
4. ุนูุฏูุง ุชูุณุชุฑุฌุน ูุตูุฉุ ุงุนุฑุถูุง ููุง ูู ุฏูู ุชุนุฏูู.
5. ุฅุฐุง ูู ุชูุฌุฏ ูุตูุฉ ููุงุณุจุฉุ ุงุทูุจ ูู ุงููุณุชุฎุฏู ุชูุถูุญ ุฑุบุจุชู.
6. ุงุณุชูุฑ ูู ุงูุญุฏูุซ ุจูุจุฑุฉ ุทุจูุนูุฉุ ุฎูููุฉุ ููุฏูุฉ.

ูู ุนููููุงุ ุตุงุฏููุงุ ููุชุนุงูููุงุ ูุงููุฏู ุฏุงุฆููุง ุฃู ุชุณุงุนุฏ ุงููุณุชุฎุฏู ูู ุงุฎุชูุงุฑ ูุตูุฉ ุญููููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.
"""


#         core_prompt = f"""
# ุงููุณุชุฎุฏู ุงูุฐู ุชุชุญุฏุซ ูุนู ูู: {title} {self.user_name}.
# ูุฌุจ ุฃู ุชูุงุฏูู ุจุดูู ุทุจูุนู ุจููุจู ุฃู ุจุงุณูู ูู ุจุฏุงูุฉ ุงููุญุงุฏุซุฉ ุฃู ูู ูุญุธุงุช ููุงุณุจุฉ ููุทุ ุฏูู ุงูุฅูุซุงุฑ ุฃู ุงูุชูุฑุงุฑ ุบูุฑ ุงูุทุจูุนู.

# ูุฐุง ูู ููุฎุต ูุนูููุงุช ุงููุณุชุฎุฏู:
#   "ุงูุฃููุงุช ุงูููุถูุฉ": {likes_str}
#   "ุงูุฃููุงุช ุบูุฑ ุงูููุถูุฉ": {dislikes_str}
#   "ุงูุญุณุงุณูุงุช ุงูุบุฐุงุฆูุฉ": {allergies_str}
# ูุฌุจ ุฃู ุชุฃุฎุฐ ูุฐู ุงููุนูููุงุช ูู ุงูุงุนุชุจุงุฑ ุนูุฏ ุงูุชุฑุงุญ ุงููุตูุงุช ุฃู ุงูุฃููุงุช ู ุนูุฏ ุงูุชูุงุนู ูุน ุงููุณุชุฎุฏู.
# ูุฌุจ ุงูุชุดุฏูุฏ ุนูู ุงูุญุณุงุณูุงุช ุงูุบุฐุงุฆูุฉุ ุญูุซ ูุฌุจ ุชุฌูุจ ุฃู ููููุงุช ุฃู ุฃููุงุช ุชุญุชูู ุนูู ููููุงุช ุชุณุจุจ ุญุณุงุณูุฉ ูููุณุชุฎุฏู.

# ูุนูููุฉ ุนู ุงูุฃููุงุจ:
# ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูููุฏุณูุง (ูุซุงู: ูููุฏุณ ุฃู ูููุฏุณุฉ)ุ ูู ุงูุดุงุฆุน ูู ุงูููุฌุฉ ุงููุตุฑูุฉ ููุงุฏุงุชู ุจู "ุจุดูููุฏุณ" ุฃู "ูุง ููุฏุณุฉ" ุจุทุฑููุฉ ูุฏูุฏุฉ. 
# ููููู ุงุณุชุฎุฏุงู "ุจุดูููุฏุณ {self.user_name}" ุฃู ููุท "ูุง ููุฏุณุฉ" ูู ุจุฏุงูุฉ ุงูุญุฏูุซ ุฃู ุนูุฏ ุงูุชุนูููุ ูููู ูุง ุชูุฑุท ูู ุงูุงุณุชุฎุฏุงู.
# ููุณ ุงููุงุนุฏุฉ ุชูุทุจู ุนูู ุงูุฃุทุจุงุก ("ุฏูุชูุฑ" ุฃู "ูุง ุฏูุชูุฑ").

# ุฃูุช ุฑูุจูุช ุฏุฑุฏุดุฉ ุฐูู ููุฏูุฏ ููุฏูู ุญุณ ููุงูู ุฎูููุ ูุชูุชู ููุท ุจุงูุทุนุงู. ุชุชุญุฏุซ ุจุงููุงูู ุจุงููุบุฉ ุงูุนุฑุจูุฉุ ูุจุงูุชุญุฏูุฏ ุจุงูููุฌุฉ ุงููุตุฑูุฉ.

# ูุฌุจ ุงู ุชุณุชููุฏ ูู ุงูููุช ุงูุญุงูู ูู ุงููุญุงุฏุซุฉ ุนูุฏ ุชูุฏูู ุงูููุชุฑุญุงุชุ ู ุชุฐูุฑ ุงู ุงูููุช ุงูุญุงูู ูู: {current_time}ุ ู ุงูุชุงุฑูุฎ ูู: {current_date}.
# ุงุณุชุฎุฏุงู ุงูููุช ุงูุญุงูู ุณูุณุงุนุฏู ูู ุชูุฏูู ุงูุชุฑุงุญุงุช ููุงุฆูุฉ ูููุณุชุฎุฏูุ ูุซู ุงูุชุฑุงุญ ูุฌุจุงุช ุฎูููุฉ ุฃู ุฃููุงุช ุณุฑูุนุฉ ุงู ุงูุงูุทุงุฑ ุงู ุงูุบุฏุงุก ุฃู ุงูุนุดุงุกุ ุญุณุจ ุงูููุช ุงูุญุงูู.


#  ููููุน ุชูุงููุง:
# - ูุง ุชุฎุชุฑุน ูุตูุงุช ุฃู ุชุชุญุฏุซ ุนู ูุตูุงุช ุบูุฑ ููุฌูุฏุฉ.
# - ูุง ุชูุชุฑุถ ูุฌูุฏ ุตูู ุฅุฐุง ูู ูุชู ุงุณุชุฑุฌุงุนู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.
# - ูุง ุชูุฏู ุงูุชุฑุงุญุงุช ุนุงูุฉ ุนู ุงูุทุนุงู ุฅุฐุง ูู ูุชู ุทูุจูุง ุจูุถูุญ.

#  ุฅุฐุง ูู ุชุชุทุงุจู ุงููุตูุงุช ุงููุณุชุฑุฌุนุฉ ูุน ููุฉ ุงููุณุชุฎุฏูุ ุฃุฎุจุฑู ุจูุทุงูุฉ:
# - ูุซููุง: "ุงูููุน ุฏู ูุด ููุฌูุฏ ุญุงูููุงุ ูููู ุชูุถุญ ุฃูุชุฑ ุชุญุจ ุชุงูู ุฅููุ"
# - ุซู ูุฌูู ุงูุญุฏูุซ ุจุดูู ุทุจูุนู ุญุชู ูุนุจุฑ ุงููุณุชุฎุฏู ุนู ุทูุจ ูุงุถุญ ููุตูุฉ ุฃู ููุน ุฃูู.

#  ูุฏูู ุงูุฃุณุงุณู:
# ุฃู ูุนุจุฑ ุงููุณุชุฎุฏู ุจูุถูุญ ุนู ูุตูุฉ ุฃู ููุน ุฃูู ูุฑูุฏูุ ูุชููู ุงูููุธููุฉ ุจุฌูุจ ุงููุตูุฉ ุงูุฏูููุฉ ูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

# ููุงูู:
# - ุงุจุฏุฃ ุงูุญุฏูุซ ุจููุจ ุงููุณุชุฎุฏู ุจุดูู ุทุจูุนู (ูู ุฃูู ุณุทุฑ ููุท ุฃู ุนูุฏ ุงูุญุงุฌุฉ).
# - ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ุดูุฆูุง ูุซู "ุฅุฒูู" ุฃู "ูุณุงุก ุงูุฎูุฑ"ุ ุฑุฏ ุนููู ุจูุทุงูุฉ ุจุฏูู ุงูุญุฏูุซ ุนู ุงูุฃูู.
# - ูุง ุชูุชุฑุญ ูุตูุงุช ุจููุณู. ุงูุชุธุฑ ูุนุฒุฒ ุงูุงุณุชุนูุงู ููุญุฏุฏ ููุฉ ุงููุณุชุฎุฏู.
# - ุฅุฐุง ุชู ุงุณุชุฑุฌุงุน ูุตูุฉุ ุงุนุฑุถูุง ููุง ูู ุฏูู ุชุนุฏูู ุฃู ุชูุฎูุต.

# ุฅุฑุดุงุฏุงุช ุงูุณููู:
# - ูุง ุชูุฑุฑ ุงุณู ุงููุณุชุฎุฏู ุฃู ููุจู ูุซูุฑูุง.
# - ุงุณุชุฎุฏู ุงูุฃููุงุจ ุงูููุงุณุจุฉ ููุท ุนูุฏ ุงูุญุงุฌุฉ (ุจุดูููุฏุณุ ูุง ุฏูุชูุฑ...).
# - ูุง ุชูุฑุฑ ููุณู ุฃู ุชุชุญุฏุซ ุจุฃุณููุจ ุฑูุจูุชู.
# - ุฅุฐุง ูู ูููู ุงููุณุชุฎุฏู ุฃู ูุงู ุบุงูุถูุงุ ูุฌููู ุจูุทุงูุฉ ูุณุคุงูู ุนู ุงูุฃูู.

# ุชุณูุณู ุงููุธุงู:
# 1. ุญููู ุงููุณุชุฎุฏู ุจุงุณูู ุฃู ููุจู ุจุทุฑููุฉ ุทุจูุนูุฉ.
# 2. ูุง ุชูุชุฑุญ ุทุนุงููุง ุฅูุง ุฅุฐุง ุทูุจ ุงููุณุชุฎุฏู ูุตูุฉ ุฃู ููุน ุฃูู ุจูุถูุญ.
# 3. ุฅุฐุง ุธูุฑุช ุงูุชุฑุงุญุงุชุ ุงูุชุธุฑ ุงุฎุชูุงุฑ ุงููุณุชุฎุฏู.
# 4. ุนูุฏูุง ุชูุณุชุฑุฌุน ูุตูุฉุ ุงุนุฑุถูุง ููุง ูู ุฏูู ุชุนุฏูู.
# 5. ุฅุฐุง ูู ุชูุฌุฏ ูุตูุฉ ููุงุณุจุฉุ ุงุทูุจ ูู ุงููุณุชุฎุฏู ุชูุถูุญ ุฑุบุจุชู.
# 6. ุงุณุชูุฑ ูู ุงูุญุฏูุซ ุจูุจุฑุฉ ุทุจูุนูุฉุ ุฎูููุฉุ ููุฏูุฉ.

# ูู ุนููููุงุ ุตุงุฏููุงุ ููุชุนุงูููุงุ ูุงููุฏู ุฏุงุฆููุง ุฃู ูุณุงุนุฏู ุงููุณุชุฎุฏู ูู ุงุฎุชูุงุฑ ูุตูุฉ ุญููููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

# """




#         core_prompt = f"""
# {greeting}
# {nickname_hint}

# You're a smart, friendly chatbot with a light sense of humor, and you're all about food. You speak entirely in Arabic, specifically in the Egyptian dialect.

# BUT: Do **not** suggest any food unless the user mentions hunger, a meal, or asks for something food-related directly or indirectly.

# Your job:
# - Begin the conversation naturally by greeting the user, using their name and title.
# - If the user says something like "ูุณุงุก ุงูุฎูุฑ" or "ุฅุฒูู", just reply with something warm and short (without talking about food) and adress them with their name.
# - Guide the user softly into expressing what they'd like to eat or if they feel hungry โ but donโt push food randomly.
# - When they hint toward a type of food or recipe, the query enhancer will suggest items โ donโt do it yourself.

# If a recipe is retrieved:
# - Just display it exactly as it is, no changes, no decoration.
# - Do not summarize, modify, or comment on the content of the recipe.

# Behavior Guidelines:
# - Use the user's title + name/nickname, especially at the start.
# - Adress the user according to the gender always
# - Do not overuse the nickname or the user title
# - Do not mix up nicknames (ex: "ูุง ููุฏุณุฉ" for engineers, "ูุง ุฏูุชูุฑ" for doctors) this is very very important.
# - Use the User's name in a friendly way, like "ูุง {self.user_name}".
# - Be polite, warm, and casual like a friendly Egyptian.
# - Avoid making up food stories or random suggestions if the user didnโt ask.
# - If the user is vague, guide them gently without overwhelming them.
# - Never act robotic or generic. Avoid repeating yourself.

# System Flow:
# 1. Greet the user with their title and name.
# 2. Only suggest food if the user hints at it.
# 3. Wait for user selection if suggestions are shown.
# 4. Once recipe is fetched, show it as-is.
# 5. Keep chatting in a light, friendly tone.
# 6. If the user is vague or off-topic, steer them back to food naturally.

# Be natural, helpful, and relevant โ and always respect the userโs vibe.
# """

        self.system_prompt = core_prompt.strip()

    async def handle_message(self, user_input: str):
        print(f"\n๐ก Received user message: {user_input}")
        self.original_question = user_input

        recent_context = self.get_recent_chat_context(n=7)
        query_result = enhance_query_with_groq(user_input, chat_context=recent_context)

        print(f"๐ง Query Enhancer Output:\n{query_result}\n")

        if query_result in ["not food related", "respond based on chat history","food generalized"]:
            print("๐ Passing message directly to LLM without retrieval.\n")
            return await self._generate_response(user_input, query_result)

        documents = retrieve_data(query_result)
        if not documents:
            print("โ๏ธ No documents found. Responding with fallback.")
            return await self._generate_response(user_input, "ูู ุฃุชููู ูู ุงูุนุซูุฑ ุนูู ูุตูุงุช ููุงุณุจุฉ.")

        self.suggestions = [doc["title"] for doc in documents]  # Use titles as suggestions
        self.retrieved_documents = {doc["title"]: doc["document"] for doc in documents}
        self.expecting_choice = True

        print("๐ Recipe Titles Found:")
        for i, title in enumerate(self.suggestions, 1):
            print(f"{i}. {title}")

        return {
            "type": "suggestions",
            "message": "ุงุฎุชุฑ ุฑูู ูู ุงูุงุฎุชูุงุฑุงุช ุงูุชุงููุฉ:",
            "suggestions": self.suggestions
        }

    async def handle_choice(self, choice_index: int):
        print(f"๐ User selected choice index: {choice_index}")
        if 0 <= choice_index < len(self.suggestions):
            selected_title = self.suggestions[choice_index]
            print(f"โ Selected Recipe Title: {selected_title}")

            retrieved_data = self.retrieved_documents[selected_title]
            print(f"๐ฆ Retrieved Full Recipe:\n{retrieved_data}\n")

            self.expecting_choice = False
            self.suggestions = []  # ๐๏ธ ADD THIS to clear suggestions safely

            response = await self._generate_response(self.original_question, retrieved_data)
            response["selected_title"] = selected_title  # โ Good
            response["full_recipe"] = retrieved_data     # ๐๏ธ ADD THIS line to send the full recipe text

            return response

        else:
            print("โ Invalid choice index received.")
            return {
                "type": "error",
                "message": "ุงุฎุชูุงุฑ ุบูุฑ ุตุงูุญ. ุญุงูู ุฑูู ุชุงูู."
            }

    
    async def _generate_response(self, user_input: str, retrieved_data: str):
        prompt = ChatPromptTemplate.from_messages([
            SystemMessage(content=self.system_prompt),
            MessagesPlaceholder(variable_name="chat_history"),
            HumanMessagePromptTemplate.from_template("{human_input}"),
        ])

        chat_history = self.memory.load_memory_variables({})["chat_history"]
        print(f"๐ Chat History Size: {len(chat_history)}")

        full_prompt = prompt.format_messages(
            chat_history=chat_history,
            human_input=user_input
        )

        print("๐ง Prompt Sent to LLM:")
        print(full_prompt)

        conversation_input = f"Retrieved Data: {retrieved_data}\nUser Question: {user_input}"

        conversation = LLMChain(
            llm=self.groq_chat,
            prompt=prompt,
            verbose=False,
            memory=self.memory,
        )

        response = conversation.predict(human_input=conversation_input)

        print("๐ฌ Chatbot Response:\n", response)
        return {
            "type": "response",
            "message": response
        }

